<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico de IA - LocalPix</title>
    <style>
        body {
            background: #1e293b;
            color: white;
            font-family: monospace;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .view {
            position: relative;
            border: 2px solid #475569;
            display: inline-block;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #logs {
            background: black;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            width: 400px;
            border: 1px solid #475569;
        }

        button {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        select {
            padding: 10px;
            font-size: 1rem;
            width: 300px;
        }
    </style>
</head>

<body>
    <h1>üî¨ Diagn√≥stico Forense de IA</h1>
    <div style="margin-bottom: 20px;">
        <select id="fileSelect">
            <option>Cargando archivos...</option>
        </select>
        <button onclick="runTest()">üß™ Ejecutar Test de Detecci√≥n</button>
        <button onclick="window.location.href='/admin'" style="background: #475569;">Volver a Admin</button>
    </div>

    <div class="container">
        <div class="view">
            <img id="testImage" style="max-width: 600px; display: block;" crossorigin="anonymous">
            <canvas id="overlay"></canvas>
        </div>
        <div id="logs"></div>
    </div>

    <!-- Cargar versi√≥n local de scripts -->
    <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const MODEL_URL = '/static/models';
        const logDiv = document.getElementById('logs');

        function log(msg, type = 'info') {
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#4ade80' : '#e2e8f0';
            logDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function init() {
            log("Iniciando sistema de diagn√≥stico...");

            // 1. Load Files
            try {
                const res = await fetch('/api/all_files');
                const files = await res.json();
                const sel = document.getElementById('fileSelect');
                sel.innerHTML = '';
                if (files.length === 0) {
                    sel.innerHTML = '<option>No hay archivos (Sube uno primero)</option>';
                } else {
                    files.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f;
                        opt.text = f;
                        sel.appendChild(opt);
                    });
                }
                log(`Archivos encontrados: ${files.length}`);
            } catch (e) { log("Error cargando archivos: " + e.message, 'error'); }
        }

        async function runTest() {
            const file = document.getElementById('fileSelect').value;
            if (!file || file.includes('Archivos')) return alert("Selecciona un archivo v√°lido");

            log("--- INICIANDO TEST ---");
            log(`Imagen: ${file}`);

            const img = document.getElementById('testImage');
            const canvas = document.getElementById('overlay');

            // 1. Load Models
            log("Cargando modelos...");
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL)
                ]);
                log("Modelos cargados correctamente.", 'success');
            } catch (e) {
                return log("FATAL: Error cargando modelos. " + e.message, 'error');
            }

            // 2. Load Image
            img.src = `/photos/${file}`;
            await new Promise((resolve) => {
                img.onload = () => {
                    log(`Imagen cargada en DOM. Dimensiones: ${img.naturalWidth}x${img.naturalHeight}`);
                    resolve();
                };
                img.onerror = () => log("Error cargando imagen (src 404?)", 'error');
            });

            // 3. Prepare Canvas
            canvas.width = img.width;
            canvas.height = img.height; // Use displayed dimensions for overlay match
            const displaySize = { width: img.width, height: img.height };
            faceapi.matchDimensions(canvas, displaySize);

            // 4. Detect - Strategy A (SSD)
            // 4. Detect - Strategy A (SSD)
            log("Ejecutando SSD MobileNet (minConfidence: 0.1)...");

            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error("Timeout: La detecci√≥n tard√≥ demasiado (>15s). Posible falta de memoria o recurso trabado.")), 15000)
            );

            let detections = [];
            try {
                detections = await Promise.race([
                    faceapi.detectAllFaces(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.1 }))
                        .withFaceLandmarks()
                        .withFaceDescriptors(),
                    timeoutPromise
                ]);
                log(`SSD Resultado: ${detections.length} rostros.`);
            } catch (err) {
                log(`‚ö†Ô∏è Fallo SSD: ${err.message}`, 'error');
            }

            // 5. Detect - Strategy B (Tiny)
            if (detections.length === 0) {
                log("Intentando TinyFaceDetector (Fallback)...");
                try {
                    detections = await Promise.race([
                        faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.1 }))
                            .withFaceLandmarks()
                            .withFaceDescriptors(),
                        timeoutPromise
                    ]);
                    log(`Tiny Resultado: ${detections.length} rostros.`);
                } catch (err) {
                    log(`‚ö†Ô∏è Fallo Tiny: ${err.message}`, 'error');
                }
            }

            // 6. Draw
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            // Clear canvas
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (detections.length > 0) {
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                log(`‚úÖ DIAGN√ìSTICO EXITOSO. Se visualizaron ${detections.length} caras.`, 'success');
            } else {
                log("‚ùå FALLO DE DETECCI√ìN. La IA no ve caras en esta imagen.", 'error');
                log("Posibles causas: Iluminaci√≥n, √°ngulo extremo, o la imagen no es una foto real.");
            }
        }

        init();
    </script>
</body>

</html>